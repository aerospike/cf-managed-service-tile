#!/bin/bash
set -ax
# RUN_DIR=/var/vcap/sys/run/aerospike
#LOG_DIR=/var/vcap/sys/log/aerospike
#PIDFILE=${RUN_DIR}/pid

SCRIPT_DIR=$(dirname $0)
. $SCRIPT_DIR/init.sh


#mkdir -p $RUN_DIR $LOG_DIR
exec &2>$LOG_DIR/aerospike.stdout.log
exec &1>$LOG_DIR/aerospike.stdout.log


if [ ! -d /var/vcap/data/aerospike || ! -d /var/vcap/data/aerospike/aerospike-server  ]
then
	mkdir -p /var/vcap/data/aerospike
	useradd -d /var/vcap/data/aerospike aerospike

	#install server
	cp /var/vcap/packages/aerospikeserver/*.* /var/vcap/data/aerospike
	pushd /var/vcap/data/aerospike
		tar -xvf aerospike.tgz 
		pushd aerospike-server
			./bin/aerospike init
		popd
	popd

	#install tools
	pushd /var/vcap/data/aerospike 
		tar -xvf aerospike-tools.tgz && cd aerospike-server-community-*
		sudo dpkg -i aerospike-tools-*.ubuntu12.04.x86_64.deb
	popd
	echo `date` Started install at /var/vcap/data/aerospike...

	#set up config file
	pushd /var/vcap/data/aerospike/aerospike-server/etc
		mv aerospike.conf aerospike.conf.orig
		cp /var/vcap/jobs/aerospikeserver/config/aerospike.conf .
	popd
fi

case $1 in

  start)
	chown -R vcap:vcap $RUN_DIR $LOG_DIR

	pushd /var/vcap/data/aerospike/aerospike-server
		./bin/aerospike start
	popd
	pgrep asd > $PIDFILE
    ;;

  stop)
	pushd  /var/vcap/data/aerospike/aerospike-server
		./bin/aerospike stop
	popd
	pgrep asd || rm $PIDFILE
	echo `date` Done killing server
    ;;

  *)
	echo "Usage: ctl {start|stop}" ;;

esac

