#!/bin/bash
set -ax
# RUN_DIR=/var/vcap/sys/run/aerospike
#LOG_DIR=/var/vcap/sys/log/aerospike
#PIDFILE=${RUN_DIR}/pid
STORE_DIR=/var/vcap/store/aerospike
DATA_DIR=/var/vcap/data/aerospike
SERVER_DIR=/var/vcap/data/aerospike/aerospike-server
CONFIG_USER=false

SCRIPT_DIR=$(dirname $0)
. $SCRIPT_DIR/init.sh

exec &2>$LOG_DIR/aerospike.stdout.log
exec &1>$LOG_DIR/aerospike.stdout.log

if [ ! -d ${DATA_DIR} || ! -d ${SERVER_DIR}  ]
then
	CONFIG_USER=true
	mkdir -p ${DATA_DIR}
	mkdir -p ${STORE_DIR}
	chown -R vcap:vcap ${STORE_DIR}
	useradd -d ${DATA_DIR} aerospike

	mkdir -p ${STORE_DIR}/{smd,{sys,usr}/udf/lua}

	#install server
	cp /var/vcap/packages/aerospike_server/*.* /var/vcap/data/aerospike

	pushd ${DATA_DIR}
		tar -xvf aerospike-server-*.tgz 
		pushd aerospike-server-*
			sudo dpkg -x aerospike-server-*.deb ../aerospike-server
			sudo dpkg -i aerospike-tools-*.deb
		popd
		sudo cp -pr ./aerospike-server/opt/aerospike/sys/udf/lua/* ${STORE_DIR}/sys/udf/lua
	popd

    sudo chown -R vcap:vcap ${STORE_DIR}/{smd,{sys,usr}/udf/lua}
fi

case $1 in

  start)
	chown -R vcap:vcap $RUN_DIR $LOG_DIR
	set_shmall
	set_shmmax
	ulimit -n 100000

	pushd /var/vcap/data/aerospike/aerospike-server
		sudo ./usr/bin/asd \
		  	--config-file /var/vcap/jobs/aerospike_server/config/aerospike.conf \
		  	start
	popd
	log_debug "LICENSE ${AEROSPIKE_LICENSE} CONFIG ${CONFIG_USER}"
	if [ "$CONFIG_USER" == true ] && [ "$AEROSPIKE_LICENSE" == "enterprise" ] ; then
		sleep 30s
		aql -Uadmin -Padmin -c "create role cf_admin privileges read-write.cf_admin"
		aql -Uadmin -Padmin -c "grant role cf_admin to admin"
		aql -Uadmin -Padmin -c "set password ${AEROSPIKE_PASSWORD} for ${AEROSPIKE_USER}"
	fi
    ;;

  stop)
	pushd  /var/vcap/data/aerospike/aerospike-server
		sudo ./usr/bin/asd stop
	popd
	echo `date` Done killing server
    ;;

  *)
	echo "Usage: ctl {start|stop}" ;;

esac

